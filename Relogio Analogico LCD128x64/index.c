#include <18F4550.h>
#use delay(clock=48000000)
//#fuses HS, PUT, NOWDT, NOBROWNOUT, NOLVP
#fuses HSPLL, PLL4, CPUDIV1, PUT, NOWDT, NOBROWNOUT, NOLVP
#include "DriverPE12864LRF.c"
#include <math.h>
#include <string.h>
#include <stdlib.h>

char const bigNumber[11][45] = {
//0
0x00, 0xf0, 0xfc, 0xfe, 0x0e, 0x07, 0x03, 0x03, 0x07, 0x1f, 0xfe, 0xfe, 0x3c, 0xf0, 0x00, 
0x00, 0xff, 0xff, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff, 0xff, 0x00, 0xff, 0x00, 
0x00, 0x1f, 0x3f, 0x7f, 0x70, 0xe0, 0xc0, 0xc0, 0xc0, 0xf0, 0x7f, 0x7f, 0x30, 0x1f, 0x00, 

//1
0x00, 0x80, 0xc0, 0xf0, 0x78, 0x3e, 0xff, 0xff, 0x05, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x03, 0x01, 0x00, 0x00, 0x00, 0xff, 0xff, 0x00, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x80, 0xc0, 0xc0, 0xc0, 0xc0, 0xff, 0xff, 0xd0, 0xff, 0xc0, 0xc0, 0xc0, 0x80, 0x00,

//2
0x00, 0xe0, 0x78, 0x3c, 0x1e, 0x0e, 0x0f, 0x0f, 0x1f, 0x3f, 0xfe, 0xfc, 0x38, 0xe0, 0x00, 
0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0xff, 0xff, 0x00, 0xff, 0x00, 
0x00, 0xc0, 0xe0, 0xf0, 0xf0, 0xf8, 0xdc, 0xce, 0xcf, 0xc7, 0xc7, 0xc3, 0xe1, 0xf1, 0x00, 

//3
0x00, 0x1e, 0x0f, 0x07, 0x03, 0x03, 0x03, 0x83, 0xc3, 0xe3, 0xfb, 0x7f, 0x3e, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x06, 0x0f, 0x0f, 0x0f, 0x0f, 0x1d, 0xf8, 0xb8, 0xe0, 0x80, 0x00, 
0x00, 0x1c, 0x78, 0x70, 0xe0, 0xe0, 0xc0, 0xc0, 0xe0, 0xf8, 0x7f, 0x27, 0x31, 0x0f, 0x00, 

//4
0x00, 0x00, 0x80, 0xc0, 0xe0, 0xf0, 0x78, 0xfc, 0xfe, 0x0b, 0xff, 0x00, 0x00, 0x00, 0x00,  
0x1c, 0x7f, 0x7f, 0x73, 0x71, 0x70, 0x70, 0xff, 0xff, 0x00, 0xff, 0x70, 0x70, 0x78, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0xc0, 0xff, 0xff, 0xd0, 0xff, 0xc0, 0x80, 0x00, 0x00, 

//5
0x00, 0xfe, 0xff, 0x0f, 0x07, 0x83, 0x83, 0x83, 0x83, 0x83, 0x07, 0x07, 0x0f, 0x00, 0x00, 
0x00, 0x1f, 0x0f, 0x06, 0x03, 0x01, 0x01, 0x01, 0x01, 0x03, 0xff, 0xfe, 0x5c, 0xf0, 0x00, 
0x00, 0x18, 0x70, 0x60, 0xe0, 0xc0, 0xc0, 0xc0, 0xe0, 0xe0, 0x7f, 0x37, 0x30, 0x1f, 0x00,  

//6
0x00, 0x80, 0xf0, 0xf8, 0x7c, 0x3e, 0x0f, 0x07, 0x03, 0x03, 0x03, 0x07, 0x0e, 0x3c, 0x00,
0x00, 0xff, 0xff, 0xc3, 0xe0, 0x30, 0x38, 0x18, 0x1c, 0x1c, 0x38, 0xf8, 0xf0, 0x60, 0x80, 
0x00, 0x07, 0x1f, 0x3f, 0x7f, 0xf0, 0xe0, 0xc0, 0x80, 0xc0, 0xe0, 0xff, 0xff, 0x69, 0x1f, 

//7
0x00, 0x3e, 0x1f, 0x07, 0x07, 0x07, 0x07, 0x07, 0x87, 0xf7, 0xff, 0xff, 0x3f, 0x0f, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xe0, 0x78, 0x9f, 0x77, 0x0f, 0x01, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x80, 0xe0, 0xf8, 0xdf, 0x73, 0x0e, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 

//8
0x00, 0xf0, 0xfc, 0xfe, 0x0f, 0x07, 0x03, 0x03, 0x03, 0x07, 0x0f, 0xfe, 0x0c, 0xf0, 0x00, 
0x00, 0x03, 0x8f, 0xdf, 0xfc, 0x38, 0x18, 0x18, 0x18, 0x3c, 0xfe, 0xdd, 0x8e, 0x07, 0x00,
0x00, 0x1f, 0x7f, 0x7f, 0xf0, 0xe0, 0xc0, 0xc0, 0xc0, 0xe0, 0xf8, 0x7f, 0x73, 0x1e, 0x00,  

//9
0x00, 0xf8, 0xfc, 0xfe, 0x0e, 0x07, 0x07, 0x03, 0x03, 0x07, 0x0f, 0x7f, 0x7f, 0xf8, 0x00, 
0x00, 0x0f, 0x0f, 0x1f, 0x38, 0x30, 0x30, 0x20, 0x30, 0x30, 0xfc, 0xff, 0x05, 0xff, 0x00, 
0x00, 0x38, 0x70, 0xe0, 0xc0, 0xc0, 0xc0, 0xc0, 0xc0, 0xe0, 0xff, 0x7f, 0x38, 0x0f, 0x00, 

//:
0x00, 0x00, 0x00, 0x00, 0x00, 0xc0, 0xe0, 0xe0, 0xe0, 0xe0, 0xc0, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x83, 0xc7, 0xc7, 0xc7, 0xc7, 0x83, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x07, 0x0f, 0x0f, 0x0f, 0x0f, 0x07, 0x00, 0x00, 0x00, 0x00};



void PE12864_TextXy(int x, int y, char* cvar);
void circulo(float aC, float bC, float r);
void circuloMenor(float aC, float bC, float r);
void circuloPonteiro(float aC, float bC, float r);
void circuloNumerico(float aC, float bC, float r);


void circulo(float aC, float bC, float r){
   int16 i = 0;
   float y, x;
   while(i <= 360){
      y = (sin(i*pi/180)*r)+bC;
      x = (cos(i*pi/180)*r)+aC;      
      PE12864_Putpixel(floor(x), floor(64-y), ON);
      i++;
   }
}
void circuloMenor(float aC, float bC, float r){
   int16 i = 0;
   float y, x;
   while(i <= 360){
      y = (sin(i*pi/180)*r)+bC;
      x = (cos(i*pi/180)*r)+aC;      
      PE12864_Putpixel(floor(x), floor(64-y), ON);
      i+=6;
   }
}
void circuloPonteiro(float aC, float bC, float r){
   int16 i = 0, mS = 0;
  // char chr[14];
   int H = 15, M = 41, S = 15, test = 0;
   float y, x;
   while(i <= 360){
      y = (sin(i*pi/180)*r)+bC;
      x = (cos(i*pi/180)*r)+aC;
      circuloNumerico(94, 29, 26);
      PE12864_circle(96,32,3,1,ON);
      PE12864_line(aC, bC, (cos(0*pi/180)*(r-11))+aC, (sin(0*pi/180)*(r-11))+bC, ON);  // hora
      PE12864_line(aC, bC, (cos((156+test)*pi/180)*(r-7))+aC, (sin((156+test)*pi/180)*(r-7))+bC, ON); // minuto     
      PE12864_line(aC, bC, x, y, ON);
      mS = 0;
      while(mS < 1000){
         /*sprintf(chr,"%u:%u:%u %lu", H, M, S, mS);
         PE12864_TextXy(3,5,chr);  */ 
         PE12864_Gotoxy(0,0);
         /*if(S > 9)
            printf(PE12864_Printchar,"%u:%u:%u", H, M, S);
         else
            printf(PE12864_Printchar,"%u:%u:0%u", H, M, S);*/
         mS+=1;
         delay_ms(1);
      }
      S++;
      if(S>59){
         S=0;
         M++;
         PE12864_line(aC, bC, (cos((156+test)*pi/180)*(r-7))+aC, (sin((156+test)*pi/180)*(r-7))+bC, OFF); // minuto              
         test+=6;
      }
      //delay_ms(1000);
      PE12864_line(aC, bC, x, y, OFF);
      i+=6;
   }   
}
void circuloNumerico(float aC, float bC, float r){
   int16 i = 0, val = 3;
   char chr[5];
   float y, x;
   while(i <= 360){
      y = (sin(i*pi/180)*r)+bC;
      x = (cos(i*pi/180)*r)+aC;       
      //PE12864_Putpixel(x, y, ON);      
      if(!(i%30)){
         sprintf(chr,"%lu", val);
         // -- Resolver Bugs :   Inicio 
         if(val == 9)
            y+=1;
         if(val == 10){
            y+=2;
            x-=1;
         }
         if(val == 11){
            y+=1;
            x-=3;
         }
         if(val == 12)
            x-=3;            
         // -- Resolver Bugs :   Fim            
         PE12864_TextXy(x,y,chr);
         val++;
         if(val > 12)    // 9: 1B 0T || 10: 2B 1T || 11: 1B 1T || 12: 0B 3T
            val = 1;
      }
      i+=30;
   }
}
void PE12864_TextXy(int x, int y, char* cvar){
   int i, loop = 0;
   char c1, c2, chr;
   while(loop < strlen(cvar)){ 
      chr = cvar[loop];
      for(i=0;i<5;i++){
         if (chr < 0x53){
            c1 = TEXT[chr-0x20][i] <<(y%8);
            c2 = TEXT[chr-0x20][i] >>(8-(y%8));               
         }
         else {
            c1 = TEXT2[chr-0x53][i] <<(y%8);
            c2 = TEXT2[chr-0x53][i] >>(8-(y%8));
         }
         PE12864_Gotoxy(x,(y/8));      
         c1 |= buffer[x][y/8];         
         PE12864_Write_data(c1);               
         PE12864_Gotoxy(x,(y/8)+1);      
         c2 |= buffer[x][(y/8)+1];
         PE12864_Write_data(c2);
         x++;
      }
      x++;
      loop++;
   }
}
void PrintBigNumber(char* c){
   int i, x = 0, loop = 0, l = 0;
   char cvar;
   while(loop < strlen(c)){   
      cvar = c[loop];
      for(i=0; i<45; i++){
         if(!(i%15))
            x = l;
         PE12864_Gotoxy(x,i/15);
         PE12864_Write_data(bigNumber[cvar-0x30][i]);
         x++;
      }
      l+=14;
      x++;
      loop++;
   }
}
void circuloFechado(float aC, float bC, float r){
   int16 i = 0;
   float y, x;
   while(i <= 360){
      y = (sin(i*pi/180)*r)+bC;
      x = (cos(i*pi/180)*r)+aC;
      PE12864_line(aC, bC, x, y, ON);      
      i++;
   }   
}
void relogioAnalogico(){
   circulo(96, 32, 32);
   circuloMenor(96, 32, 30);
   circuloNumerico(94, 29, 26); 
   circuloPonteiro(96, 32, 28);
   /*circulo(64, 32, 32);
   circuloMenor(64, 32, 30);
   circuloNumerico(62, 29, 26); 
   circuloPonteiro(64, 32, 28);*/
}
void main(void){
   PE12864_InitLcd();
   char chr[10];
  
   sprintf(chr,"15:41");
   PrintBigNumber(chr);
   PE12864_Gotoxy(0,6);
   printf(PE12864_Printchar, "21/07/2011");   
   PE12864_Gotoxy(0,7);
   printf(PE12864_Printchar, "Quinta-feira!");      
   
   relogioAnalogico();
   while(true){}
}
